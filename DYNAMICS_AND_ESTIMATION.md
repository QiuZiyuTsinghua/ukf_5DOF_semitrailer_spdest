# 半挂卡车5-DOF动力学建模与UKF速度估计器

## 概述

本文档详细介绍基于半挂卡车平面五自由度（5-DOF）动力学模型的Unscented Kalman Filter（UKF）状态估计器的设计原理、数学建模和工程实现。该估计器主要用于实时估计半挂卡车的运动状态，包括纵横向速度、航向角速度和铰接角等关键参数。

## 1. 动力学建模

### 1.1 建模假设

1. **平面运动假设**：车辆在水平面内运动，忽略侧倾、俯仰和垂直运动
2. **刚体假设**：牵引车和挂车均视为刚体
3. **小角度假设**：轮胎侧偏角较小，采用线性轮胎模型
4. **理想铰接**：铰接点无摩擦，只传递力和力矩

### 1.2 坐标系定义

采用车身固连坐标系，原点位于牵引车质心，x轴指向前方，y轴指向左侧，z轴垂直向上。

### 1.3 状态变量

半挂卡车5-DOF模型的状态变量为：

```
x = [Vx, Vy, r, ψ, ψ̇]ᵀ
```

其中：
- `Vx`: 牵引车纵向速度 (m/s)
- `Vy`: 牵引车横向速度 (m/s)  
- `r`: 牵引车航向角速度 (rad/s)
- `ψ`: 铰接角，挂车与牵引车纵轴夹角 (rad)
- `ψ̇`: 铰接角速度 (rad/s)

### 1.4 控制输入

```
u = [δf, Fdrive]ᵀ
```

其中：
- `δf`: 前轮转向角 (rad)
- `Fdrive`: 纵向驱动力 (N)

### 1.5 动力学方程

#### 1.5.1 轮胎侧偏角计算

```cpp
// 前轮侧偏角
αf = δf - (Vy + a·r) / Vx

// 后轮侧偏角  
αr = -(Vy - bt·r) / Vx

// 挂车轮胎侧偏角
αs = ψ - (Vy,s - bs·rs) / Vx,s
```

#### 1.5.2 挂车运动学关系

```cpp
// 挂车质心速度（牵引车坐标系）
Vx,s = Vx·cos(ψ) + (Vy + Lh·r)·sin(ψ)
Vy,s = -Vx·sin(ψ) + (Vy + Lh·r)·cos(ψ)

// 挂车航向角速度
rs = r + ψ̇
```

#### 1.5.3 力平衡方程

**牵引车纵向动力学：**
```
m_t·(V̇x - r·Vy) = Fdrive + Fyf·sin(δf) - Fyh·sin(ψ)
```

**牵引车横向动力学：**
```
m_t·(V̇y + r·Vx) = Fyf·cos(δf) + Fyr - Fyh·cos(ψ)
```

**牵引车横摆动力学：**
```
Izt·ṙ = a·Fyf·cos(δf) - bt·Fyr - Lh·Fyh·cos(ψ)
```

**铰接角动力学：**
```
ψ̈ = ṙs - ṙ
```

其中铰接力采用线性模型：
```
Fyh = kh·ψ + ch·ψ̇
```

#### 1.5.4 轮胎力模型

采用线性轮胎模型：
```cpp
Fyi = -Cαi · αi
```

其中 `Cαi` 为各轮胎的侧偏刚度。

## 2. UKF状态估计器

### 2.1 UKF算法原理

Unscented Kalman Filter通过确定性采样（Sigma点）来处理非线性系统的状态估计问题，相比扩展卡尔曼滤波器（EKF）具有更高的精度和数值稳定性。

### 2.2 系统模型

**状态预测模型：**
```
xk+1 = f(xk, uk) + wk
```

**观测模型：**
```
zk = h(xk) + vk
```

其中：
- `f(·)`: 非线性状态转移函数（车辆动力学模型）
- `h(·)`: 非线性观测函数
- `wk ~ N(0, Q)`: 过程噪声
- `vk ~ N(0, R)`: 测量噪声

### 2.3 Sigma点生成

采用Merwe缩放采样方法：

```cpp
// 中心点
χ0 = x̄

// 正负扰动点
χi = x̄ + (√((n+λ)P))i,     i = 1,...,n
χi = x̄ - (√((n+λ)P))i-n,   i = n+1,...,2n
```

权重计算：
```cpp
Wm0 = λ/(n+λ)
Wc0 = λ/(n+λ) + (1-α²+β)
Wmi = Wci = 1/(2(n+λ)),     i = 1,...,2n
```

参数设置：
- `α = 1e-3`: 控制Sigma点分布
- `β = 2`: 高阶矩匹配参数（高斯分布最优值）
- `κ = 0`: 二次项参数

### 2.4 预测步骤

1. **Sigma点预测**：
   ```cpp
   χk+1|k = f(χk|k, uk)
   ```

2. **状态预测**：
   ```cpp
   x̂k+1|k = Σ Wmi · χk+1|k,i
   ```

3. **协方差预测**：
   ```cpp
   Pk+1|k = Σ Wci · (χk+1|k,i - x̂k+1|k)(χk+1|k,i - x̂k+1|k)ᵀ + Q
   ```

### 2.5 更新步骤

1. **观测Sigma点变换**：
   ```cpp
   Zk+1|k,i = h(χk+1|k,i)
   ```

2. **观测预测**：
   ```cpp
   ẑk+1|k = Σ Wmi · Zk+1|k,i
   ```

3. **创新协方差**：
   ```cpp
   S = Σ Wci · (Zk+1|k,i - ẑk+1|k)(Zk+1|k,i - ẑk+1|k)ᵀ + R
   ```

4. **交叉协方差**：
   ```cpp
   T = Σ Wci · (χk+1|k,i - x̂k+1|k)(Zk+1|k,i - ẑk+1|k)ᵀ
   ```

5. **卡尔曼增益与状态更新**：
   ```cpp
   K = T · S⁻¹
   x̂k+1|k+1 = x̂k+1|k + K(zk+1 - ẑk+1|k)
   Pk+1|k+1 = Pk+1|k - K · S · Kᵀ
   ```

### 2.6 观测模型

系统观测向量包括：
```
z = [v_wheel, r_gyro, ψ_encoder, ax_accel]ᵀ
```

其中：
- `v_wheel`: 轮速传感器测量的速度
- `r_gyro`: 陀螺仪测量的航向角速度
- `ψ_encoder`: 铰接角编码器测量值
- `ax_accel`: 加速度计测量的纵向加速度

观测方程：
```cpp
h(x) = [Vx, r, ψ, ax_estimated]ᵀ
```

## 3. 工程实现

### 3.1 数值稳定性处理

1. **角度归一化**：
   ```cpp
   double normalizeAngle(double angle) {
       while (angle > M_PI) angle -= 2.0 * M_PI;
       while (angle < -M_PI) angle += 2.0 * M_PI;
       return angle;
   }
   ```

2. **除零保护**：
   ```cpp
   double Vx_safe = std::max(std::abs(Vx), 0.1);
   if (Vx < 0) Vx_safe = -Vx_safe;
   ```

3. **协方差矩阵正定性**：
   使用Cholesky分解确保数值稳定性

### 3.2 采样时间考虑

推荐采样频率：100Hz (Ts = 0.01s)
- 满足半挂卡车动态响应要求
- 与常见传感器采样率匹配
- 计算负荷适中

### 3.3 参数调优指导

**过程噪声协方差 Q**：
```cpp
Q = diag([0.1, 0.1, 0.01, 0.01, 0.01])
```
- 纵横向速度噪声：0.1 m/s
- 航向角速度噪声：0.01 rad/s
- 铰接角相关噪声：0.01 rad, 0.01 rad/s

**测量噪声协方差 R**：
```cpp
R = diag([0.1, 0.01, 0.05, 0.1])
```
- 轮速测量精度：0.1 m/s
- 陀螺仪精度：0.01 rad/s
- 铰接角编码器精度：0.05 rad
- 加速度计精度：0.1 m/s²

## 4. 性能验证

### 4.1 仿真验证

建议测试工况：
1. **直线加减速**：验证纵向动力学
2. **定圆转向**：验证横向动力学
3. **双移线**：验证组合工况性能
4. **蛇形机动**：验证铰接角估计

### 4.2 评价指标

1. **状态估计精度**：与参考值的均方根误差（RMSE）
2. **收敛性**：估计协方差的收敛特性
3. **鲁棒性**：参数摄动下的性能稳定性
4. **实时性**：算法执行时间

## 5. 嵌入式部署注意事项

### 5.1 内存优化

- 避免动态内存分配
- 使用固定大小的矩阵
- 减少临时变量创建

### 5.2 计算优化

- 利用矩阵对称性
- 缓存重复计算结果
- 使用查找表替代超越函数

### 5.3 数值精度

- 使用double精度浮点数
- 注意条件数较大的矩阵运算
- 定期重置协方差矩阵

## 参考文献

1. Julier, S.J. & Uhlmann, J.K. "Unscented Filtering and Nonlinear Estimation", Proceedings of the IEEE, 2004.
2. Rajamani, R. "Vehicle Dynamics and Control", 2nd Edition, Springer, 2012.
3. Kural, E. & Jones, R.P. "Articulated Vehicle Lateral Dynamics and Control", SAE Technical Paper, 2007.
4. ISO 14791:2020 "Road vehicles - Heavy vehicle combinations - Dynamic test methods".
